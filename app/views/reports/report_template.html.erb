<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @report_data[:title] || "Threat Intelligence Report" %></title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
</head>
<body style="font-family: 'Orbitron', Arial, sans-serif; margin: 0; padding: 0; background-color: #d7d1c6; color: #0d1c28;">

  <div style="max-width: 700px; margin: auto; padding: 40px; background-color: #ffffff; border-radius: 10px;">

    <!-- Logo -->
    <div style="border-radius: 50%; width: 140px; height: 140px; margin: 0 auto 30px; background: #ffffff; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
      <a href="https://www.pwnandpatch.com" target="_blank" style="display: block;">
        <%= image_tag 'oktoboot-red-logo.png', alt: 'Oktoboot Logo', style: 'width: 120px; border-radius: 50%;' %>
      </a>
    </div>

    <!-- Title -->
    <h1 style="font-size: 32px; color: #143852; font-weight: 700; margin-bottom: 15px; text-align: center;">
      <%= @report_data[:title] || "Threat Intelligence Report" %>
    </h1>

    <!-- Domain Scope -->
    <p style="font-size: 18px; color: #07a8dc; font-weight: 600; margin-bottom: 30px; text-align: center;">
      <%= @report_data.dig(:executive_summary, :targets_scope) || "Unspecified Domain" %>
    </p>

    <!-- Created/Updated -->
    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; margin-bottom: 40px;">
      <div style="background-color: #f8fafc; padding: 10px 16px; border-radius: 8px; border-left: 4px solid #143852;">
        <p style="font-size: 0.875rem; color: #64748b; margin: 0; font-weight: 500;">Created At</p>
        <p style="font-size: 1rem; color: #1e293b; margin: 4px 0 0; font-weight: 600;"><%= @report_data[:created_at]&.strftime("%B %d, %Y %H:%M") || "N/A" %></p>
      </div>
      <div style="background-color: #f8fafc; padding: 10px 16px; border-radius: 8px; border-left: 4px solid #07a8dc;">
        <p style="font-size: 0.875rem; color: #64748b; margin: 0; font-weight: 500;">Updated At</p>
        <p style="font-size: 1rem; color: #1e293b; margin: 4px 0 0; font-weight: 600;"><%= @report_data[:updated_at]&.strftime("%B %d, %Y %H:%M") || "N/A" %></p>
      </div>
    </div>

    <!-- Report Metadata -->
    <div style="margin: 40px 0; padding: 30px; border-radius: 12px; background-color: #f8fafc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'">
      <h3 style="font-size: 1.75rem; color: #1e293b; font-weight: 600; margin-bottom: 20px; text-align: center; letter-spacing: -0.025em;">Report Metadata</h3>

      <table style="width: 100%; font-size: 0.9375rem; color: #1e293b; border-collapse: collapse;">
        <tr>
          <td style="padding: 12px; text-align: right; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">Version:</td>
          <td style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0;"><%= @report_data.dig(:report_metadata, :report_version) || "N/A" %></td>
        </tr>
        <tr>
          <td style="padding: 12px; text-align: right; font-weight: 500; color: #64748b; border-bottom: 1px solid #e2e8f0;">Generated By:</td>
          <td style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0;"><%= @report_data.dig(:report_metadata, :generated_by) || "N/A" %></td>
        </tr>
        <tr>
          <td style="padding: 12px; text-align: right; font-weight: 500; color: #64748b;">Generated At:</td>
          <td style="padding: 12px; text-align: left;"><%= @report_data.dig(:report_metadata, :generated_at)&.strftime("%B %d, %Y %H:%M") || "N/A" %></td>
        </tr>
      </table>
    </div>

    <!-- Executive Summary -->
    <div style="margin: 40px 0; padding: 30px; border-radius: 12px; background-color: #f8fafc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0;">
      <h3 style="font-size: 1.75rem; color: #1e293b; font-weight: 600; margin-bottom: 20px; text-align: center; letter-spacing: -0.025em;">Executive Summary</h3>
    
      <% overview = @report_data.dig(:executive_summary, :overview) %>
      <% targets = @report_data.dig(:executive_summary, :targets_scope) %>
      <% highlights = @report_data.dig(:executive_summary, :high_level_findings) %>
    
      <% if overview.present? %>
        <div style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #143852;">
          <p style="font-size: 1rem; color: #1e293b; line-height: 1.6; margin: 0;"><strong style="color: #07a8dc;">Overview:</strong> <%= overview %></p>
        </div>
      <% end %>
    
      <% if targets.present? %>
        <div style="background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #143852;">
          <p style="font-size: 1rem; color: #1e293b; line-height: 1.6; margin: 0;"><strong style="color: #07a8dc;">Scope:</strong> <%= targets %></p>
        </div>
      <% end %>
    
      <!-- Metric Boxes -->
      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 30px; justify-content: center;">
        <% if highlights.present? %>
          <% subdomains = highlights[/discovered (\d+) subdomains/, 1] %>
          <% assets = highlights[/identified (\d+) exposed assets/, 1] %>
          <% leaks = highlights[/uncovered (\d+) leaked credential sets/, 1] %>
    
          <% if subdomains %>
            <div style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
              <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 0.9375rem; font-weight: 500;">Subdomains</p>
              <p style="margin: 8px 0 0; font-size: 2rem; font-weight: 700; color: white;"><%= subdomains %></p>
            </div>
          <% end %>
    
          <% if assets %>
            <div style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
              <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 0.9375rem; font-weight: 500;">Exposed Assets</p>
              <p style="margin: 8px 0 0; font-size: 2rem; font-weight: 700; color: white;"><%= assets %></p>
            </div>
          <% end %>
    
          <% if leaks %>
            <div style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
              <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 0.9375rem; font-weight: 500;">Leaked Credentials</p>
              <p style="margin: 8px 0 0; font-size: 2rem; font-weight: 700; color: white;"><%= leaks %></p>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
    
 <!-- Methodology Section -->
    <div style="page-break-before: always; margin-top: 40px;"></div>
    <% methodology = @report_data[:methodology] || [] %>
    <% task_categories = {
      "DNS Record Enumeration" => "Domain & DNS Intelligence",
      "WHOIS Enumeration" => "Domain & DNS Intelligence",
      "ASN Enumeration" => "Network & Infrastructure",
      "Subdomain Enumeration" => "Discovery",
      "Certificate Fetching" => "Discovery",
      "Shared Hosting Check" => "Network & Infrastructure",
      "Assets Search" => "Exposed Assets",
      "Logstealers Search" => "Leak Detection",
      "Search Leaks" => "Leak Detection",
      "Combo Search" => "Leak Detection",
      "Fetch Organization Info" => "Employee Informations",
      "Employees Search" => "Employee Informations",
      "File Scraper" => "Discovery",
      "Process Found Files" => "Analysis & Processing"
    } %>
    
    <% critical_tasks = ["Logstealers Search", "Search Leaks", "Process Found Files", "Assets Search"] %>
    
    <% if methodology.any? %>
      <div style="margin: 40px 0; padding: 30px; border-radius: 12px; background-color: #f8fafc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0;">
        <h3 style="font-size: 1.75rem; color: #1e293b; font-weight: 600; margin-bottom: 20px; text-align: center; letter-spacing: -0.025em;">Methodology</h3>
    
        <% grouped = methodology.group_by { |task| task_categories[task[:task]] || "Other" } %>
    
        <% grouped.each do |category, tasks| %>
          <div style="margin-bottom: 30px;">
            <h4 style="font-size: 1.25rem; color: #1e293b; margin-bottom: 15px; border-bottom: 2px solid #07a8dc; padding-bottom: 8px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 8px;">
                <% if category.include?("DNS") %>
                  🌐
                <% elsif category.include?("Network") %>
                  📶
                <% elsif category.include?("Discovery") %>
                  🔍
                <% elsif category.include?("Leak") %>
                  🚨
                <% elsif category.include?("Employee") %>
                  👥
                <% elsif category.include?("Analysis") %>
                  📊
                <% else %>
                  📋
                <% end %>
              </span>
              <%= category %>
            </h4>
            <div style="margin-top: 15px;">
              <% tasks.each do |task| %>
                <% is_critical = critical_tasks.include?(task[:task]) %>
                <div style="margin-bottom: 20px; padding: 16px; border-radius: 8px; background-color: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid <%= is_critical ? '#dc2626' : '#143852' %>;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="font-size: 1.0625rem; color: <%= is_critical ? '#dc2626' : '#1e293b' %>;">
                      <%= task[:task] %>
                    </strong>
                    <% if is_critical %>
                      <span style="background-color: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">CRITICAL</span>
                    <% end %>
                  </div>
                  <div style="display: flex; gap: 16px; font-size: 0.875rem; color: #64748b;">
                    <span><strong>Status:</strong> <%= task[:status] %></span>
                  </div>
                  <p style="font-size: 0.9375rem; color: #475569; margin-top: 8px; margin-bottom: 0; line-height: 1.5;"><%= task[:description] %></p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
    
 <!-- Findings Section -->
    <div style="page-break-before: always;"></div>
    <% dns_info = @report_data.dig(:findings, :domain_dns_intelligence) || {} %>
    <% dns_summary = dns_info[:dns_records_summary] || {} %>
    <% whois = dns_info[:whois_info_shown] || [] %>

    <% if dns_info.present? %>
      <div style="margin: 40px 0; padding: 30px; border-radius: 12px; background-color: #f8fafc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0;">

        <!-- Domain & DNS Intelligence Header -->
        <h3 style="font-size: 1.75rem; color: #1e293b; font-weight: 600; margin-bottom: 20px; text-align: center; letter-spacing: -0.025em;">Domain & DNS Intelligence</h3>
        
        <!-- Domain Info -->
        <div style="margin-bottom: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid #143852;">
          <h4 style="font-size: 1.25rem; color: #1e293b; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
            <span style="margin-right: 8px;">🌐</span> Domains
          </h4>
          <div style="background-color: #eff6ff; padding: 12px 16px; border-radius: 6px;">
            <p style="font-size: 0.9375rem; color: #1e293b; margin: 0; font-weight: 500;">
              <strong style="color: #07a8dc;">Total Domains Identified:</strong> <%= dns_info[:domains] || 0 %>
            </p>
          </div>
        </div>

        <!-- DNS Records -->
        <div style="margin-bottom: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid #07a8dc;">
          <h4 style="font-size: 1.25rem; color: #1e293b; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center;">
            <span style="margin-right: 8px;">📡</span> DNS Records
          </h4>

          <!-- NS Records -->
          <% if dns_summary[:ns_records_info].present? %>
            <h5 style="font-size: 1.0625rem; color: #475569; margin-bottom: 15px; font-weight: 500;">NS Records</h5>
            <div style="overflow-x: auto;">
              <table style="width: 100%; font-size: 0.875rem; color: #475569; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; border-radius: 8px; overflow: hidden;">
                <thead>
                  <tr style="background-color: #f1f5f9;">
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Name</th>
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">IP</th>
                  </tr>
                </thead>
                <tbody>
                  <% dns_summary[:ns_records_info].each do |record| %>
                    <tr style="background-color: white;">
                      <td style="padding: 12px 16px; font-size: 0.8rem; color: #475569; border-bottom: 1px solid #e2e8f0;"><%= record[:name] %></td>
                      <td style="padding: 12px 16px; font-size: 0.8rem; color: #475569; border-bottom: 1px solid #e2e8f0;"><%= record[:ip] %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div style="background-color: #f8fafc; padding: 16px; border-radius: 6px; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748b; margin: 0;">No NS Records found.</p>
            </div>
          <% end %>
            <!-- MX Records -->
            <!-- MX Records -->
            <% if dns_summary[:mx_records_info].present? %>
              <h5 style="font-size: 1.0625rem; color: #475569; margin-bottom: 15px; font-weight: 500;">MX Records</h5>
              <div style="overflow-x: auto;">
                <table style="width: 100%; font-size: 0.875rem; color: #475569; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; border-radius: 8px; overflow: hidden;">
                  <thead>
                    <tr style="background-color: #f1f5f9;">
                      <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Name</th>
                      <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Priority</th>
                      <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Target</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% dns_summary[:mx_records_info].each_with_index do |record, index| %>
                      <tr style="background-color: <%= index % 2 == 0 ? 'white' : '#f8fafc' %>; border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:name] %></td>
                        <td style="padding: 12px 16px;font-size: 0.8rem;"><%= record[:priority] %></td>
                        <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:target] %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
                <% if dns_summary[:mx_note].present? %>
                  <p style="font-size: 0.8125rem; color: #64748b; font-style: italic; margin-top: 8px; padding-left: 5px;">
                    <%= dns_summary[:mx_note] %>
                  </p>
                <% end %>
              </div>
            <% else %>
              <div style="background-color: #f8fafc; padding: 16px; border-radius: 6px; text-align: center; margin-bottom: 20px;">
                <p style="font-size: 0.875rem; color: #64748b; margin: 0;">No MX Records found.</p>
              </div>
            <% end %>
        </div>

        <!-- WHOIS Records -->
        <% if whois.any? %>
          <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid #0d73c5;">
            <h4 style="font-size: 1.25rem; color: #1e293b; margin-bottom: 20px; font-weight: 600; display: flex; align-items: center;">
              <span style="margin-right: 8px;">📝</span> WHOIS Information
            </h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; font-size: 0.875rem; color: #475569; border-collapse: separate; border-spacing: 0; border-radius: 8px; overflow: hidden;">
                <thead>
                  <tr style="background-color: #f1f5f9;">
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Domain</th>
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Registrar</th>
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Created</th>
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Updated</th>
                    <th align="left" style="padding: 12px 16px; font-size: 0.875rem; color: #334155; font-weight: 600; border-bottom: 1px solid #e2e8f0;">Expires</th>
                  </tr>
                </thead>
                <tbody>
                <% whois.each_with_index do |record, index| %>
                  <tr style="background-color: <%= index % 2 == 0 ? 'white' : '#f8fafc' %>;">
                    <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:domain] || record[:domain_name] %></td>
                    <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:registrar] %></td>
                    <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:created_at] %></td>
                    <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:updated_at] || 'N/A' %></td>
                    <td style="padding: 12px 16px; font-size: 0.8rem;"><%= record[:expires_at] || 'N/A' %></td>
                  </tr>
                <% end %>
                </tbody>
              </table>
              <% if dns_info[:whois_note] %>
              <p style="font-size: 13px; color: #aaaaaa; margin-top: 5px;"><%= dns_info[:whois_note] %></p>
            <% end %>
            </div>
          </div>
        <% else %>
          <div style="background-color: #f8fafc; padding: 16px; border-radius: 6px; text-align: center; margin-top: 20px;">
            <p style="font-size: 0.875rem; color: #64748b; margin: 0;">No WHOIS information available.</p>
          </div>
        <% end %>
      </div>
    <% end %>

        <div style="page-break-before: always;"></div>
    <% network = @report_data.dig(:findings, :network_infrastructure) || {} %>
    <% shared_summary = network[:shared_hosting_summary] || {} %>
    <% shared_hosts = shared_summary[:hosts] || [] %>

    <% if network[:asn_count].to_i > 0 || shared_hosts.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px;text-align: center;">Network Infrastructure</h3>

        <!-- ASN Count -->
        <% if network[:asn_count].to_i > 0 %>
          <h4 style="font-size: 16px; color: #4b566b; margin-bottom: 8px;">AS Number Overview</h4>
          <p style="font-size: 14px; color: #5c7598;">
            <strong>Total ASNs Identified:</strong> <%= network[:asn_count] %>
          </p>
        <% end %>

        <!-- Shared Hosting Exposure -->
        <% if shared_hosts.any? %>
          <h4 style="font-size: 16px; color: #121e2b; margin-top: 25px; margin-bottom: 10px;">Shared Hosting Exposure</h4>
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #ccd0d6;">
                <th align="left" style="padding: 6px;">Domain</th>
                <th align="left" style="padding: 6px;">Shared With</th>
              </tr>
            </thead>
            <tbody>
              <% shared_hosts.each do |host| %>
                <% next if host[:domain].blank? && (host[:shared_with] || []).compact.empty? %>
                <tr>
                  <td style="padding: 6px;"><%= host[:domain] %></td>
                  <td style="padding: 6px;">
                    <ul style="margin: 0; padding-left: 0; list-style-type: none;">
                      <% host[:shared_with].each do |shared| %>
                        <li><%= shared %></li>
                      <% end %>
                      <% if host[:shared_with_truncated] %>
                        <li style="color: #aaaaaa;"><em>(truncated)</em></li>
                      <% end %>
                    </ul>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>

          <% if shared_summary[:note].present? %>
            <p style="font-size: 13px; color: #aaaaaa;"><%= shared_summary[:note] %></p>
          <% end %>
        <% end %>
      </div>
    <% end %>
    


    <div style="page-break-before: always;"></div>
    <% subdomains = @report_data.dig(:findings, :subdomain_enumeration) || {} %>
    <% shown = subdomains[:shown] || [] %>

    <% if subdomains[:total_found].to_i > 0 %>
      <div style="margin: 40px 0;padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center;">Subdomain Enumeration</h3>

        <!-- Description -->
        <p style="font-size: 14px; color: #4b566b; margin-bottom: 15px;">
          This section highlights a sample of the subdomains identified during the reconnaissance process. The full list — along with associated technologies, open ports, and vulnerabilities — is available in the Oktoboot dashboard for deeper investigation and remediation.
        </p>

        <!-- Total Count -->
        <p style="font-size: 14px; color: #4b566b; margin-bottom: 10px;">
          <strong>Total Unique Subdomains Found:</strong> <%= subdomains[:total_found] %>
        </p>

        <!-- Grouped Table -->
        <% grouped = shown.group_by { |s| s.split('.').last(2).join('.') } %>
        <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #ccd0d6;">
              <th align="left" style="padding: 6px;">Root Domain</th>
              <th align="left" style="padding: 6px;">Subdomain</th>
            </tr>
          </thead>
          <tbody>
            <% grouped.each do |root, subs| %>
              <% subs.each_with_index do |sd, index| %>
                <% style = case sd
                  when /admin|login|secure/i then 'color: #ff7b7b; font-weight: 600;'
                  when /dev|test|staging/i then 'color: #73c2fb; font-weight: 600;'
                  when /internal|private|backup/i then 'color: #ffc078; font-weight: 600;'
                  else ''
                end %>
                <tr>
                  <td style="padding: 6px;"><%= index.zero? ? root : "" %></td>
                  <td style="padding: 6px; <%= style %>"><%= sd %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>

        <% if subdomains[:note].present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;"><%= subdomains[:note] %></p>
        <% end %>
      </div>
    <% end %>


    <div style="page-break-before: always;"></div>
    <% certs = @report_data.dig(:findings, :certificate_https, :certificates) || [] %>
    <% if certs.any? %>
      <% now = Time.now.utc %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center;">Certificate HTTPS Enumeration</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 15px;">
          This section summarizes digital certificates discovered during reconnaissance. Certificates may reveal subdomains or exposure timelines. Review carefully — and check Oktoboot Dashboard for full details.
        </p>
        <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #ccd0d6;">
              <th align="left" style="padding: 6px;">Common Name</th>
              <th align="left" style="padding: 6px;">Valid From</th>
              <th align="left" style="padding: 6px;">Valid To</th>
            </tr>
          </thead>
          <tbody>
            <% certs.each do |cert| %>
              <% begin %>
                <% valid_to = cert[:valid_to].present? ? Time.parse(cert[:valid_to]) : nil %>
              <% rescue %>
                <% valid_to = nil %>
              <% end %>

              <% is_expired = valid_to.present? && valid_to < now %>
              <tr>
                <td style="padding: 6px;"><%= cert[:common_name].presence || "N/A" %></td>
                <td style="padding: 6px;"><%= cert[:valid_from].presence || "N/A" %></td>
                <td style="padding: 6px; <%= is_expired ? 'color: #ff7b7b; font-weight: 600;' : '' %>">
                  <%= cert[:valid_to].presence || "N/A" %>
                  <% if is_expired %><span style="color: #ff7b7b;"> (expired)</span><% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <% if certs.size == 5 %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;">
            Only the first 5 certificates are shown. View the Oktoboot dashboard for the full list.
          </p>
        <% end %>
      </div>
    <% end %>


    
    <div style="page-break-before: always;"></div>
    <% assets = @report_data.dig(:findings, :exposed_assets, :shown) || [] %>
    <% if assets.any? %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 15px;text-align: center">Exposed Assets Overview</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
          These exposed assets may pose risk due to open ports, outdated services, or certificate leaks. Risk levels and recommendations are based on observed configurations and known vulnerabilities.
        </p>

        <% assets.each do |asset| %>
            <!-- Asset Title -->
            <h4 style="color: #9ecfff; font-size: 18px; font-weight: 700; margin-bottom: 10px;"><%= asset[:ip] %></h4>

            <!-- Inline Metadata -->
            <div style="font-size: 14px; color: #4b566b; margin-bottom: 12px;">
              <strong>Domain:</strong> <%= asset[:domain].presence || "N/A" %> &nbsp;|&nbsp;
              <strong>ISP:</strong> <%= asset[:isp].presence || "N/A" %> &nbsp;|&nbsp;
              <strong>Risk:</strong> 
              <span style="<%= case asset[:risk_level]
                              when "High" then 'color: #ff7b7b; font-weight: 600;'
                              when "Medium" then 'color: #ffc078; font-weight: 600;'
                              when "Low" then 'color: #73c2fb; font-weight: 600;'
                              else ''
                            end %>">
                <%= asset[:risk_level] %>
              </span>
            </div>

            <!-- Open Ports -->
            <% if asset[:open_ports].present? %>
              <h5 style="font-size: 15px; color: #4b566b; font-weight: 600; margin-top: 20px;">Open Ports</h5>
              <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px;">
                <thead>
                  <tr style="background-color: #ccd0d6;">
                    <th align="left" style="padding: 8px;">Port</th>
                    <th align="left" style="padding: 8px;">Module</th>
                    <th align="left" style="padding: 8px;">Version</th>
                    <th align="left" style="padding: 8px;">SSL</th>
                  </tr>
                </thead>
                <tbody>
                  <% asset[:open_ports].each do |port| %>
                    <tr>
                      <td style="padding: 6px;"><%= port[:port] %></td>
                      <td style="padding: 6px;"><%= port[:module] %></td>
                      <td style="padding: 6px;"><%= port[:version].presence || "N/A" %></td>
                      <td style="padding: 6px;">
                        <% if port[:ssl].present? %>
                          <% port[:ssl].each do |ssl| %>
                            <div style="margin-bottom: 3px;">
                              <strong><%= ssl[:common_name] %></strong><br>
                              <span style="font-size: 12px; color: #bbbbbb;"><%= ssl[:issuer] %> | <%= ssl[:versions] %></span>
                            </div>
                          <% end %>
                        <% else %>
                          N/A
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            <% end %>

            <!-- Top Vulnerabilities -->
            <% if asset[:vulnerabilities].present? %>
              <h5 style="font-size: 15px; color: #4b566b; font-weight: 600; margin-top: 25px;">Top Vulnerabilities</h5>
              <% asset[:vulnerabilities].first(5).each do |vuln| %>
                <div style="margin-bottom: 18px;">
                  <div style="font-size: 14px; font-weight: bold; color: #73c2fb; margin-bottom: 3px;">
                    <%= vuln[:title] %>
                  </div>
                  <div style="font-size: 13px; color: 
                    <%= case vuln[:severity]
                          when 'Critical' then '#c0392b' 
                          when 'High' then '#ff7b7b'
                          when 'Medium' then '#ffc078'
                          else '#bbbbbb'
                      end %>;">
                    <%= vuln[:severity] %> severity — CVSS: <%= vuln[:cvss] %>
                  </div>
                  <div style="font-size: 13px; color: #4b566b; margin-top: 4px;">
                    <%= vuln[:description] %>
                  </div>
                </div>
              <% end %>

              <% if asset[:vulnerabilities].size > 5 %>
                <p style="font-size: 12px; color: #aaaaaa;"><em>Only the first 5 vulnerabilities are shown. See dashboard for more.</em></p>
              <% end %>
            <% end %>

            <!-- Recommendation -->
            <% if asset[:recommendation].present? %>
              <p style="margin-top: 25px; font-size: 14px; color: #4b566b; font-weight: 600;">Recommended Mitigation</p>
              <p style="font-size: 13px; color: #4b566b; margin-top: 5px;"><%= asset[:recommendation] %></p>
            <% end %>
        <% end %>

        <% if @report_data.dig(:findings, :exposed_assets, :note).present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 10px;"><%= @report_data.dig(:findings, :exposed_assets, :note) %></p>
        <% end %>
      </div>
    <% end %>


<div style="page-break-before: always;"></div>
<% leaks = @report_data.dig(:findings, :data_leaks_and_breaches) || {} %>
<% if leaks[:logstealer_leaks][:total].to_i > 0 || leaks[:public_leaks][:total].to_i > 0 || leaks[:combo_leaks][:total].to_i > 0 %>
  <div style="margin: 40px 0; padding: 30px; border-radius: 10px; background-color: #f4f6f9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
    <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #ccd0d6; padding-bottom: 10px;">Data Leaks & Credential Exposure</h3>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 25px; line-height: 1.5;">
      These exposed credentials were found across malware logs, public breaches, and combo lists. They may be linked to user accounts or internal access points. Please investigate and rotate impacted credentials immediately. Full dump available in the Oktoboot dashboard.
    </p>

    <!-- Logstealer Leaks -->
    <% if leaks[:logstealer_leaks][:shown].present? %>
      <div style="margin-bottom: 30px;">
        <h4 style="font-size: 16px; color: #143852; font-weight: 600; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e3e8;">Logstealer Leaks</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 6px; overflow: hidden;">
            <thead>
              <tr style="background-color: #143852; color: white;">
                <th align="left" style="padding: 10px 12px; font-weight: 500;">URL</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Email</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Password</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:logstealer_leaks][:shown].each_with_index do |entry, index| %>
                <tr style="border-bottom: 1px solid #e0e3e8; <%= 'background-color: #f9fafb;' if index.odd? %>">
                  <td style="padding: 10px 12px; word-break: break-word;"><%= entry[2] %></td>
                  <td style="padding: 10px 12px;"><%= entry[0] %></td>
                  <td style="padding: 10px 12px; font-family: monospace;"><%= entry[1] %></td>
                  <td style="padding: 10px 12px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if leaks[:logstealer_leaks][:note].present? %>
          <p style="font-size: 12px; color: #6c757d; font-style: italic; margin-top: 8px; padding-left: 5px;"><%= leaks[:logstealer_leaks][:note] %></p>
        <% end %>
      </div>
    <% end %>

    <div style="page-break-before: always;"></div>

    <!-- Public Breach Leaks -->
    <% if leaks[:public_leaks][:shown].present? %>
      <div style="margin-bottom: 30px;">
        <h4 style="font-size: 16px; color: #143852; font-weight: 600; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e3e8;">Public Breach Leaks</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 6px; overflow: hidden;">
            <thead>
              <tr style="background-color: #143852; color: white;">
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Leak Source</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Email</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Password</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:public_leaks][:shown].each_with_index do |entry, index| %>
                <tr style="border-bottom: 1px solid #e0e3e8; <%= 'background-color: #f9fafb;' if index.odd? %>">
                  <td style="padding: 10px 12px;"><%= entry[0] %></td>
                  <td style="padding: 10px 12px;"><%= entry[1] %></td>
                  <td style="padding: 10px 12px; font-family: monospace;"><%= entry[2] %></td>
                  <td style="padding: 10px 12px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if leaks[:public_leaks][:note].present? %>
          <p style="font-size: 12px; color: #6c757d; font-style: italic; margin-top: 8px; padding-left: 5px;"><%= leaks[:public_leaks][:note] %></p>
        <% end %>
      </div>
    <% end %>

    <div style="page-break-before: always;"></div>

    <!-- Combo List Leaks -->
    <% if leaks[:combo_leaks][:shown].present? %>
      <div style="margin-bottom: 30px;">
        <h4 style="font-size: 16px; color: #143852; font-weight: 600; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e3e8;">Combo List Leaks</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 6px; overflow: hidden;">
            <thead>
              <tr style="background-color: #143852; color: white;">
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Domain</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Email</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Password</th>
                <th align="left" style="padding: 10px 12px; font-weight: 500;">Year</th>
              </tr>
            </thead>
            <tbody>
              <% leaks[:combo_leaks][:shown].each_with_index do |entry, index| %>
                <tr style="border-bottom: 1px solid #e0e3e8; <%= 'background-color: #f9fafb;' if index.odd? %>">
                  <td style="padding: 10px 12px;"><%= entry[0] %></td>
                  <td style="padding: 10px 12px;"><%= entry[1] %></td>
                  <td style="padding: 10px 12px; font-family: monospace;"><%= entry[2] %></td>
                  <td style="padding: 10px 12px;"><%= entry[3] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if leaks[:combo_leaks][:note].present? %>
          <p style="font-size: 12px; color: #6c757d; font-style: italic; margin-top: 8px; padding-left: 5px;"><%= leaks[:combo_leaks][:note] %></p>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>


    <div style="page-break-before: always;"></div>
    <% employees = @report_data.dig(:findings, :employee_information) || {} %>
    <% shown = employees[:shown] || [] %>

    <% if employees[:total_found].to_i > 0 %>
      <div style="margin: 40px 0; padding: 25px; border-radius: 8px;">
        <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px;text-align: center;">Employee Enumeration</h3>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 12px;">
          This section lists publicly accessible employees discovered during reconnaissance. Full role breakdowns and exposure context are available in the Oktoboot dashboard.
        </p>

        <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
          <strong>Total Identified:</strong> <%= employees[:total_found] %>
        </p>

        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
          <% shown.each do |emp| %>
            <div style="flex: 1 1 45%; background-color: #1a273b; padding: 12px 16px; border-radius: 6px;">
              <p style="margin: 0; font-size: 14px; font-weight: 600; color: #ffffff;"><%= emp[:fullname] %></p>
              <p style="margin-top: 4px; font-size: 13px; color: #cccccc;"><%= emp[:poste].presence || "N/A" %></p>
            </div>
          <% end %>
        </div>

        <% if employees[:note].present? %>
          <p style="font-size: 13px; color: #aaaaaa; margin-top: 20px;"><%= employees[:note] %></p>
        <% end %>
      </div>
    <% end %>


<div style="page-break-before: always;"></div>
<% employees = @report_data.dig(:findings, :employee_information) || {} %>
<% shown = employees[:shown] || [] %>

<% if employees[:total_found].to_i > 0 %>
  <div style="margin: 40px 0; padding: 25px; border-radius: 8px; background-color: #f9f9f9;">
    <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px; text-align: center;">Employee Enumeration</h3>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 12px;">
      This section lists publicly accessible employees discovered during reconnaissance. Full role breakdowns and exposure context are available in the Oktoboot dashboard.
    </p>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
      <strong>Total Identified:</strong> <%= employees[:total_found] %>
    </p>

    <div style="display: flex; flex-wrap: wrap; gap: 16px;">
      <% shown.each do |emp| %>
        <div style="flex: 1 1 45%; background-color: #1a273b; padding: 12px 16px; border-radius: 6px;">
          <p style="margin: 0; font-size: 14px; font-weight: 600; color: #ffffff;"><%= emp[:fullname] %></p>
          <p style="margin-top: 4px; font-size: 13px; color: #cccccc;"><%= emp[:poste].presence || "N/A" %></p>
        </div>
      <% end %>
    </div>

    <% if employees[:note].present? %>
      <p style="font-size: 13px; color: #aaaaaa; margin-top: 20px;"><%= employees[:note] %></p>
    <% end %>
  </div>
<% end %>

<div style="page-break-before: always;"></div>
<% meta = @report_data.dig(:findings, :metadata_public_files) || {} %>
<% files = meta[:files] || [] %>
<% sensitive = meta[:sensitive_data] || [] %>

<% if files.any? || sensitive.any? %>
  <div style="margin: 40px 0; padding: 25px; border-radius: 8px; background-color: #f9f9f9;">
    <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px; text-align: center;">Metadata & Public Files</h3>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 16px;">
      This section lists publicly accessible files and detected metadata exposures. View complete data in your Oktoboot dashboard.
    </p>

    <% if files.any? %>
      <h4 style="font-size: 16px; color: #4b566b; font-weight: 600; margin-bottom: 10px;">Discovered Files</h4>
      <table style="width: 100%; font-size: 13px; color: #4b566b; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #ccd0d6;">
            <th align="left" style="padding: 8px;">File Name</th>
            <th align="left" style="padding: 8px;">URL</th>
          </tr>
        </thead>
        <tbody>
          <% files.each do |file| %>
            <tr style="border-bottom: 1px solid #333;">
              <td style="padding: 6px; vertical-align: top;"><%= file[:name].presence || "N/A" %></td>
              <td style="padding: 6px; vertical-align: top;">
                <% if file[:url].present? %>
                  <a href="<%= file[:url] %>" target="_blank" style="color: #4fb7ff; word-break: break-word; text-decoration: underline;">
                    <%= file[:url] %>
                  </a>
                <% else %>
                  N/A
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
<% end %>

<div style="page-break-before: always;"></div>
<% risks = @report_data[:risk_assessment] || {} %>
<% high_risks = risks[:high_risks] || [] %>
<% medium_risks = risks[:medium_risks] || [] %>
<% info_risks = risks[:info_risks] || [] %>

<% if high_risks.any? || medium_risks.any? || info_risks.any? %>
  <div style="margin: 40px 0; padding: 25px; border-radius: 8px; background-color: #f9f9f9;">
    <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 16px; text-align: center;">Risk Assessment</h3>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 20px;">
      The following risks were identified during the reconnaissance phase. They are categorized by severity and may require immediate remediation or strategic consideration.
    </p>

    <% if high_risks.any? %>
      <h4 style="font-size: 16px; color: #ff6b6b; font-weight: 600; margin-top: 20px;">High Risks</h4>
      <% high_risks.each do |risk| %>
        <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
          <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
        </div>
      <% end %>
    <% end %>

    <% if medium_risks.any? %>
      <h4 style="font-size: 16px; color: #f7c948; font-weight: 600; margin-top: 30px;">Medium Risks</h4>
      <% medium_risks.each do |risk| %>
        <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
          <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
        </div>
      <% end %>
    <% end %>

    <% if info_risks.any? %>
      <h4 style="font-size: 16px; color: #9ecfff; font-weight: 600; margin-top: 30px;">Informational</h4>
      <% info_risks.each do |risk| %>
        <div style="color: #5c7598; margin-left: 10px; margin-top: 6px;">
          <span style="font-weight: 500;">‣</span> <span><%= risk %></span>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>

<div style="page-break-before: always;"></div>
<% recommendations = @report_data[:recommendations] || {} %>
<% if recommendations.values.flatten.any? %>
  <div style="margin: 40px 0; padding: 25px; border-radius: 8px; background-color: #f9f9f9;">
    <h3 style="font-size: 20px; color: #121e2b; font-weight: 700; margin-bottom: 20px; text-align: center;">
      Recommendations
    </h3>

    <p style="font-size: 14px; color: #4b566b; margin-bottom: 16px;">
      Prioritized guidance based on reconnaissance findings. Grouped by severity for operational clarity.
    </p>

    <% {
      "Critical" => [recommendations[:critical], "#ff4c4c"],
      "Important" => [recommendations[:important], "#f7c948"],
      "Best Practice" => [recommendations[:best_practice], "#4fb7ff"]
    }.each do |severity, (items, color)| %>
      <% if items.any? %>
        <h4 style="font-size: 16px; color: <%= color %>; font-weight: 600; margin-top: 30px;">
          <%= severity %> Recommendations
        </h4>

        <% items.each do |rec| %>
          <div style="margin-bottom: 18px; padding: 12px; border-left: 4px solid <%= color %>; border-radius: 4px;">
            <p style="margin: 0; font-size: 14px; color: <%= color %>;">
              <strong>Area:</strong> <%= rec[:area] %>
            </p>
            <p style="margin: 6px 0 0; font-size: 14px; color: #5c7598;">
              <%= rec[:recommendation] %>
            </p>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>

  </div>
</body>
</html>
